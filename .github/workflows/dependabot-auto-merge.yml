name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  checks: read
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Wait for CI checks to complete
        # Wait for the CI workflow to complete before enabling auto-merge
        # This prevents merging with failing tests or linting issues
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          echo "Waiting for CI checks to complete..."

          # Wait up to 10 minutes for CI to complete
          timeout=600
          elapsed=0
          interval=10

          while [ $elapsed -lt $timeout ]; do
            # gh pr checks uses GraphQL statusCheckRollup, which is inaccessible to the
            # restricted GITHUB_TOKEN in Dependabot workflows. Use the REST check-runs API
            # instead, which respects the checks: read permission above.
            pr_sha=$(gh pr view "$PR_URL" --json headRefOid --jq '.headRefOid')
            check_status=$(gh api "repos/$GITHUB_REPOSITORY/commits/$pr_sha/check-runs" \
              --jq '.check_runs[] | select(.name == "scan_ruby" or .name == "scan_js" or .name == "lint" or .name == "test") | "\(.name):\(.status):\(.conclusion)"')

            # Check if all required jobs are completed
            all_completed=true
            all_successful=true

            while IFS= read -r check; do
              [ -z "$check" ] && continue
              name=$(echo "$check" | cut -d: -f1)
              status=$(echo "$check" | cut -d: -f2)
              conclusion=$(echo "$check" | cut -d: -f3)

              if [ "$status" != "completed" ]; then
                all_completed=false
                echo "  $name: still running (status: $status)..."
              elif [ "$conclusion" = "success" ]; then
                echo "  $name: passed"
              else
                all_successful=false
                echo "  $name: failed with conclusion '$conclusion'"
              fi
            done <<< "$check_status"

            # If all checks completed and all succeeded, we're done
            if [ "$all_completed" = true ] && [ "$all_successful" = true ]; then
              echo "All CI checks passed!"
              break
            fi

            # If all checks completed but some failed, exit with error
            if [ "$all_completed" = true ] && [ "$all_successful" = false ]; then
              echo "CI checks failed. Not enabling auto-merge."
              exit 1
            fi

            # Wait before checking again
            sleep $interval
            elapsed=$((elapsed + interval))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for CI checks to complete"
            exit 1
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto-merge for patch and minor updates
        # Only enable auto-merge after CI checks have passed
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        # Leave a comment on major updates explaining why we didn't auto-merge
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "⚠️ This is a **major version update** and requires manual review before merging.

          Please review the changelog and test thoroughly before merging."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
